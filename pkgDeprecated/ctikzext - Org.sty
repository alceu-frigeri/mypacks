%%%==============================================================================
%% Copyright 2023-present by Alceu Frigeri
%%
%% This work may be distributed and/or modified under the conditions of
%%
%% * The [LaTeX Project Public License](http://www.latex-project.org/lppl.txt),
%%   version 1.3c (or later), and/or
%% * The [GNU Affero General Public License](https://www.gnu.org/licenses/agpl-3.0.html),
%%   version 3 (or later)
%%
%% This work has the LPPL maintenance status *maintained*.
%%
%% The Current Maintainer of this work is Alceu Frigeri
%%
%% This is version {0.1} {2023/12/05}
%%
%% The list of files that compose this work can be found in the README.md file at
%% https://ctan.org/pkg/ufrgscca
%%
%%%==============================================================================
%% WARNING: These are personal packs/tests
%%          They might and probably will change at will as needed
%% 
%%%==============================================================================
\NeedsTeXFormat{LaTeX2e}[2022/06/01]


\ProvidesExplPackage
    {ctikzext}
    {2023/12/05}
    {0.1}
    {CircuiTikZ Extensions}

%%%%%%%
%%%
%%% Just an attempt of having my packages info in a regular way
%%% Idea being: { <pck-name> / pkg info } for each and all.
%%%
%%%%%%%
\keys_define:nn { ctikzext / pkg info}
  {
     name        .code:n = {ctikzext} ,
     prefix      .code:n = {ctikzext} ,
     date        .code:n = {2023/12/05},
     version     .code:n = {0.1} ,
     description .code:n = {CircuiTikZ Extensions}
  }
\cs_if_exist:NF \__codedesc_pkg_info:nn 
  {
    \cs_new_protected:Npn \__codedesc_pkg_info:nn #1#2
      { \keys_set:nn {#1 / pkg info}{#2} }
  }
\cs_if_exist:NF \PkgInfo
  { \NewDocumentCommand \PkgInfo {mm} { \keys_set:nn {#1 / pkg info}{#2} } }
\cs_if_exist:NF \PkgDescription
  { 
    \NewDocumentCommand \PkgDescription {m} 
      { 
        \noindent Package~ \textbf{\PkgInfo{#1}{name}}~Version:~\PkgInfo{#1}{version}~ -~ \PkgInfo{#1}{date}\par \emph{\PkgInfo{#1}{description}}~\par 
      } 
  }  
%%%%%%%
%%% End of cut-n-paste
%%%%%%%

\RequirePackage{etoolbox}
\RequirePackage[T1]{fontenc}
\RequirePackage[utf8]{inputenc}


\keys_define:nn {ctikzext }
  {
    showframe .usage:n = load ,
    showframe .bool_set:N = \l__ctikzext_showframe_bool ,

    showlabels .usage:n = load ,
    showlabels .bool_set:N = \l__ctikzext_showlabels_bool ,

    english .usage:n = load ,
    english .bool_set:N = \l__ctikzext_english_bool ,

    noalias .usage:n = load ,
    noalias  .bool_set:N = \l__ctikzext_noalias_bool ,

    beamer .usage:n = load ,
    beamer  .bool_set:N = \l__ctikzext_beamer_bool ,
    
    xpacks .usage:n = load ,
    xpacks  .bool_set:N = \l__ctikzext_xpacks_bool ,
    
    times .usage:n = load ,
    times  .bool_set:N = \l__ctikzext_times_bool ,
    
    xtrakeys .usage:n = general ,
    xtrakeys .tl_set:N = \l__ctikzext_xtrakeys_tl ,
    xtrakeys .value_required:n  = true ,
  }
\ProcessKeyOptions [ ctikzext ]

\makeatletter
\tl_if_empty:NTF \l__ctikzext_xtrakeys_tl
  {
    \def\ctikzext@@xtratkey{}
  }
  {
    \exp_args:NNe\def\ctikzext@@xtratkey{,\l__ctikzext_xtrakeys_tl}
  }


\makeatother


\RequirePackage{xcolor}

\bool_if:NTF \l__ctikzext_beamer_bool
  {}
  { %these have problems with beamer
    \RequirePackage[a4paper,margin=15mm,right=15mm,marginparwidth=0cm,asymmetric,top=2.5cm,bottom=1.5cm]{geometry}
    \RequirePackage[calcwidth]{titlesec}
    \RequirePackage{listings}
    \definecolor{lstgray}{rgb}{0.965,0.965,0.965}%
    \lstset{basicstyle=\ttfamily\small,%
      columns=fullflexible,%
      keepspaces=true,%
      frame=tb,%
      inputencoding=latin1,%
      %  inputencoding=utf8,%
      extendedchars=true,%
      backgroundcolor=\color{lstgray},%
    	breaklines=true,%
      %	xleftmargin=7pt,%
      %	xrightmargin=7pt%
    }%
    %%%
    %%% from https://en.wikibooks.org/wiki/LaTeX/Source_Code_Listings#Encoding_issue
    \lstset{literate=
      {á}{{\'a}}1 {é}{{\'e}}1 {í}{{\'i}}1 {ó}{{\'o}}1 {ú}{{\'u}}1
      {Á}{{\'A}}1 {É}{{\'E}}1 {Í}{{\'I}}1 {Ó}{{\'O}}1 {Ú}{{\'U}}1
      {à}{{\`a}}1 {è}{{\`e}}1 {ì}{{\`i}}1 {ò}{{\`o}}1 {ù}{{\`u}}1
      {À}{{\`A}}1 {È}{{\'E}}1 {Ì}{{\`I}}1 {Ò}{{\`O}}1 {Ù}{{\`U}}1
      {ä}{{\"a}}1 {ë}{{\"e}}1 {ï}{{\"i}}1 {ö}{{\"o}}1 {ü}{{\"u}}1
      {Ä}{{\"A}}1 {Ë}{{\"E}}1 {Ï}{{\"I}}1 {Ö}{{\"O}}1 {Ü}{{\"U}}1
      {â}{{\^a}}1 {ê}{{\^e}}1 {î}{{\^i}}1 {ô}{{\^o}}1 {û}{{\^u}}1
      {Â}{{\^A}}1 {Ê}{{\^E}}1 {Î}{{\^I}}1 {Ô}{{\^O}}1 {Û}{{\^U}}1
    	{ã}{{\~{a}}}1 {õ}{{\~{o}}}1
    	{Ã}{{\~{A}}}1 {Õ}{{\~{O}}}1
      {œ}{{\oe}}1 {Œ}{{\OE}}1 {æ}{{\ae}}1 {Æ}{{\AE}}1 {ß}{{\ss}}1
      {ç}{{\c c}}1 {Ç}{{\c C}}1 {ø}{{\o}}1 {å}{{\r a}}1 {Å}{{\r A}}1
      {€}{{\EUR}}1 {£}{{\pounds}}1
    }
  }


\bool_if:NT \l__ctikzext_showframe_bool
  {
    \RequirePackage{showframe}
  }

\bool_if:NT \l__ctikzext_showlabels_bool
  {
    \RequirePackage{showlabels}
  }

\bool_if:NTF \l__ctikzext_english_bool
  {
    \RequirePackage[english]{babel}
  }
  {
    \RequirePackage[brazilian]{babel}
  }


\bool_if:NT \l__ctikzext_xpacks_bool
  {
    \RequirePackage{longtable}%
    \RequirePackage{fancyhdr}
    \RequirePackage{csquotes}
    \RequirePackage[position=above,font=small,labelfont=bf,textfont=md,textfont+=sl,width=.80\textwidth]{caption}
    \RequirePackage{subcaption}
    \RequirePackage{url}% Para imprimir corretamente URLs
    \RequirePackage{multirow,bigdelim}
  }
\bool_if:NTF \l__ctikzext_times_bool
  { \RequirePackage{mathptmx} }
  { \RequirePackage{lmodern} }


\RequirePackage{enumerate}% Para poder enumerar com letras ao inves de numeros

\RequirePackage{keyval,graphicx}  % Para importar figuras
\RequirePackage{amsmath, amsthm, amssymb, amsfonts}
\RequirePackage{mathrsfs}
\RequirePackage{mathtools}
\RequirePackage{empheq}
\RequirePackage{cases}
\RequirePackage{extarrows}
\RequirePackage{mathfixs}

\RequirePackage{steinmetz}


%
% pgf/tikz packages can't be loaded in an Expl3 code regim 
%
\ExplSyntaxOff

\RequirePackage[american,siunitx,cuteinductors,smartlabels,arrowmos,EFvoltages,betterproportions]{circuitikz}
%%\RequirePackage{pgffor}
\usetikzlibrary{fit,math,calc,fpu}
\usetikzlibrary{arrows,shapes}
\usetikzlibrary{shapes.geometric} %needed for the triangle
\usetikzlibrary{shapes.misc} %needed for the triangle
\usetikzlibrary{graphs,3d}
\usetikzlibrary{datavisualization,datavisualization.formats.functions}
\usetikzlibrary[commutative-diagrams]  %% oriented graphs.

\NewDocumentCommand{\pgfmathparseFPU}{+m}{%
  \begingroup%
  \pgfkeys{/pgf/fpu,/pgf/fpu/output format=fixed}%
  \pgfmathparse{#1}%
  \pgfmathsmuggle\pgfmathresult%
  \endgroup%
  }

\RequirePackage{pgfplots}
\pgfplotsset{compat=1.18}
\usetikzlibrary{pgfplots.units}

\ExplSyntaxOn

\keys_define:nn {ctikzext / cab}
  {
    class .usage:n = general ,
    class .tl_set:N = \l__ctikzext_class_tl ,
    class .value_required:n  = true ,
    class .initial:n         = {nome disciplina} ,

    classcode .usage:n = general ,
    classcode .tl_set:N = \l__ctikzext_code_tl ,
    classcode .value_required:n  = true ,
    classcode .initial:n         = {ENG-code} ,
    
    exam .usage:n = general ,
    exam .tl_set:N = \l__ctikzext_exam_tl ,
    exam .value_required:n  = true ,
    exam .initial:n         = {XX Verificação de Aproveitamento} ,
    
    
    semester .usage:n = general ,
    semester .tl_set:N = \l__ctikzext_semester_tl ,
    semester .value_required:n  = true ,
    semester .initial:n         = {202x / y} ,
    
    simplegrad .usage:n = general ,
    simplegrad .bool_set:N = \l__ctikzext_simplegrad_bool ,

    duo .usage:n = general ,
    duo .bool_set:N = \l__ctikzext_duo_bool ,
  }

\NewDocumentCommand{\cab}{m}
  {
   \keys_set:nn{ctikzext / cab}{#1}
   \newpage
   \begin{center}
     {
       \sc\large Universidade ~\ Federal\ ~ do\ ~ Rio\ ~ Grande\ ~ do\ ~ Sul\\
       Escola\ ~ de\ ~ Engenharia\ ~ /\ ~ DELAE \\
       \l__ctikzext_code_tl \ ~-\ ~\l__ctikzext_class_tl\\ 
       \l__ctikzext_exam_tl \ ~-\ ~ \l__ctikzext_semester_tl\\[2ex]
     }
     \bool_if:nT {\l__ctikzext_simplegrad_bool}
       {
         \__ctikzext_simplecab:
       }
       
     Nome:\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\vspace{10mm}
Cartão:\ldots\ldots\ldots\ldots\ldots\ldots

     \bool_if:nT {\l__ctikzext_duo_bool}
       {\\[-3ex]Dupla:\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\vspace{10mm}
Cartão:\ldots\ldots\ldots\ldots\ldots\ldots}
   \end{center}
  }
  

\cs_new:Npn \__ctikzext_simplecab:
  {
    \fbox{%
          \footnotesize%
      	  \begin{minipage}{.6\textwidth}%
            Assinalar~ um~ “\textbf{X}”,~ no~ tipo~ de~ correção~ a~ ser~ realizada.
      			  \begin{description}%
       	        \item[(~\ )~ Simplificada]~	Será~ atribuída~ uma~ nota~ igual~ a~ $3$~ –--~ independente~ do~ que~ estiver~ escrito~ na~ prova.
       	        \item[(~\ )~ Completa]~	Todas~ as~ questões~ serão~ corrigidas~ e~ a~ nota~ será~ dada~ pela~ soma~ dos~ pontos~ obtidos~ em~ cada~ questão.~ Neste~ caso,~ a~ nota~ estará~ no~ intervalo~ $[0;10]$.
              \end{description}
          \end{minipage}%
      	}\\[3ex]%
  }

%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%
%%
%%
%%
%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%

%%
%% For once, spaces (pgf/tikz) and then ':' 
%%
\ExplSyntaxOff
\def\normalcoord(#1){coordinate(#1)  node(n-#1){}}
\newcommand{\normalcoords}{\let\coord=\normalcoord}
\newcommand{\showcoords}{\let\coord=\showcoord}
\let\coord=\normalcoord


\def\genpincoord[#1,#2](#3){%
  coordinate(#3) node(n-#3){}%
  node[circle, #1,  inner sep=1.2pt, outer sep=0pt, radius=1pt, fill=#1!20!white, fill opacity=0.2, draw opacity=0.4, draw,
    pin={[#1, overlay, inner sep=0pt, outer sep=1pt, font=\tiny, pin distance=4pt,
    pin edge={#1, overlay}]#2:#3}](pin-#3){}%
  }
      
\def\pincoord(#1){\genpincoord[blue,-45](#1)}
\def\showcoord(#1){\genpincoord[red,45](#1)}
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%
%%
%%
%%
%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%
\prop_new:N \l__ctikzext_questions_prop
\NewDocumentCommand{\defQuestion}{m+m}
  {
    \prop_put:Nnn {\l__ctikzext_questions_prop}{#1}{#2}
  }
\NewDocumentCommand{\defQuestionAlias}{mm}
  {
    \bool_if:NF \l__ctikzext_noalias_bool
      {
        \prop_put:Nnn {\l__ctikzext_questions_prop}{#1}{\prop_item:Nn \l__ctikzext_questions_prop {#2}}
      }
  }
  
\tl_new:N \l__ctikzext_quest_tl  
\NewDocumentCommand{\ftikzQuestion}{O{0.66}mO{}}
  {
    \prop_get:NnNTF \l__ctikzext_questions_prop {#2} \l__ctikzext_quest_tl
      {
    		\begin{figure}[!htb]
    			\begin{center}
    				\resizebox{#1\textwidth}{!}{
    				\begin{tikzpicture}
              \__ctikzext_pgfkeys:n{#3}
    					\l__ctikzext_quest_tl
    				\end{tikzpicture}}
    			\end{center}
    		\end{figure}    
      }
      {
    		\begin{figure}[!htb]
    			\begin{center}
            Invalid~key:~#2
    			\end{center}
    		\end{figure}           
      }
  }  
  
\NewDocumentCommand{\tikzQuestion}{O{0.66}mO{}}
  {
    \prop_get:NnNTF \l__ctikzext_questions_prop {#2} \l__ctikzext_quest_tl
      {
				\resizebox{#1\textwidth}{!}{
				\begin{tikzpicture}
          \__ctikzext_pgfkeys:n{#3}
  				\l__ctikzext_quest_tl
				\end{tikzpicture}}
      }
      {
        Invalid~key:~#2
      }
  }  
\NewDocumentCommand{\rawQuestion}{mO{}}
  {
    \prop_get:NnNTF \l__ctikzext_questions_prop {#2} \l__ctikzext_quest_tl
      {
        \__ctikzext_pgfkeys:n{#2}
 				\l__ctikzext_quest_tl
      }
      {
        Invalid~key:~#2
      }
  }

\NewDocumentCommand{\Questionslist}{}
  {
    \seq_gclear_new:N \l__ctikzext_questions_seq
    \prop_map_inline:Nn \l__ctikzext_questions_prop
      {
        \seq_put_right:Nn \l__ctikzext_questions_seq {##1}
      }
%      \seq_show:N \l__ctikzext_questions_seq
    \seq_sort:Nn \l__ctikzext_questions_seq
      {
        \str_compare:eNeTF { ##1 } > { ##2 }
          { \sort_return_swapped: }
          { \sort_return_same: }
      }
%      \seq_show:N \l__ctikzext_questions_seq
    \begin{description}
      \seq_map_inline:Nn \l__ctikzext_questions_seq
        {
          \item[\raisebox{3em}{##1}] \tikzQuestion[0.33]{##1}
        }    
    \end{description}
  }

%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%
%%
%%
%%
%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%
%\ExplSyntaxOff
%


\pgfplotsset{width=0.7\textwidth}

\NewDocumentCommand{\loglogplot}{O{}mmO{}}{
  % Preamble: \pgfplotsset{width=7cm,compat=1.16}
  \begin{tikzpicture}
    \begin{loglogaxis}[
      /pgfplots/log~ identify~ minor~ tick~ positions=true,
      grid=both,
      tick~ align=outside,
      width=0.8\textwidth,
      height=0.4\textwidth,
      log~ basis~ y=10,
      x~ unit=rad/s,
      xlabel=$\omega$,
      axis~ line~ style={color=blue,very~ thick},
      axis~ x~ line=bottom,
      axis~ y~ line=left,
      #1 ]
      \addplot[color=red] gnuplot[id=#2,samples=2000] {#3};
      #4
\end{loglogaxis}
\end{tikzpicture}
}


\NewDocumentCommand{\semilogplot}{O{}mmO{}}{
  % Preamble: \pgfplotsset{width=7cm,compat=1.16}
  \begin{tikzpicture}
    \begin{semilogxaxis}[
      /pgfplots/log~ identify~ minor~ tick~ positions=true,
      grid=both,
      tick~ align=outside,
      width=0.9\textwidth,
      height=0.4\textwidth,
      x~ unit=rad/s,
      %      minor tick = 5,
      minor~ y~ tick~ num = 1,
      xlabel=$\omega$,
      axis~ line~ style={color=blue,very~ thick},
      axis~ x~ line=bottom,
      axis~ y~ line=left,
      #1 ]
      \addplot[color=red] gnuplot[id=#2,samples=2000] {#3};
      #4
    \end{semilogxaxis}
  \end{tikzpicture}
}

\NewDocumentCommand{\semilogphiplot}{O{}mmO{}}{
  % Preamble: \pgfplotsset{width=7cm,compat=1.16}
  \semilogplot
    [ y~ unit=rad,
      ytick={-3.14159265,-2.3561945,-1.570796,-0.785398,0,0.785398,1.570796,2.3561945,3.14159265},
      #1 ]
    {#2}
    {#3}
    [#4]
}

\NewDocumentCommand{\semilogdbplot}{O{}mmO{}}{
  % Preamble: \pgfplotsset{width=7cm,compat=1.16}
  \semilogplot
    [ y~ unit=db,
      ytick = {-20,0,20,40,60,80},
      minor~ y~ tick~ num = 3,
      #1 ]
    {#2}
    {#3}
    [#4]
}


\cs_new:Npn \__ctikzext_pgfkeys:n #1
  { \pgfkeys{/Zval, #1} }

\ExplSyntaxOff


\makeatletter

%
%\newcommand{\ctikzext@@SetDef}[2][]{%
\NewDocumentCommand{\ctikzext@@SetDef}{O{}m}{%
  \pgfkeys{%
	  /Zval, default/.append style={/Zval/#2, default},%
	  /Zval/#2/.is family, /Zval/#2, default/.style={},%
		keyset/.code={\pgfkeysalso{%
		  default/.append style = {##1=#2_{#1{##1}}},%
			##1/.code={\csedef{#2##1}{$####1$}}%
		}},%
		setaux/.code={\pgfkeysalso{keyset/.list/.expanded={##1a,##1b,##1c,##1d,##1e,##1f,##1g,##1h,##1i,##1j,##1k,##1l,##1m,##1n,##1o,##1p,##1q,##1r,##1s,##1t,##1u,##1v,##1w,##1x,##1y,##1z}}},%
		setaux/.list/.expanded={,a,b,c,d,e,f,g}%
	}%
}%
%


\AtBeginDocument{\ctikzext@@KeysDef}

\NewDocumentCommand{\ctikzext@@KeysDef}{}{%
  \pgfkeys{/Zval/.is family, /Zval, default/.style={},%
	  defset/.code={\ctikzext@@SetDef{##1}},%
		defset/.list/.expanded={R,L,C,Z,K,T,Q,EQ,X,Y,D,M,N,A,B,U\ctikzext@@xtratkey},%
		defset/.code={\ctikzext@@SetDef[f_]{##1}},%
		defset/.list/.expanded={V,I},%
		default%
	}%
}%



\newtoggle{ctikzext@@toggle@inverted}
\newtoggle{ctikzext@@toggle@generic}
\newtoggle{ctikzext@@toggle@alternate}
\newtoggle{ctikzext@@toggle@innerocirc}
\newtoggle{ctikzext@@toggle@outerocirc}
\newtoggle{ctikzext@@toggle@beziertip}
\newtoggle{ctikzext@@toggle@roundsources}
%
%
%
\def\ctikzext@@KeysPath{/tikz/QuadKeys}
\pgfkeys{\ctikzext@@KeysPath/.is family}
\newcommand{\ctikzext@@ValueofQuadKey}[1]{\pgfkeysvalueof{\ctikzext@@KeysPath/#1}}
%\newcommand{\ctikzext@@QuadKey}[1]{\pgfkeys{\ctikzext@@KeysPath,#1}}
\newcommand{\ctikzext@@QuadGetAnchor}[2]{\pgfkeys{\ctikzext@@KeysPath,#1={#2}}}

\def\ctikzext@@RPath{/tikz/QuadKeys/Anchor +90 Rotation}
\pgfkeys{\ctikzext@@RPath/.is family}
\pgfkeys{\ctikzext@@RPath,
    south/.code={\csdef{#1}{west}},
    south east/.code={\csdef{#1}{south west}},
    east/.code={\csdef{#1}{south}},
    north east/.code={\csdef{#1}{south east}},
    north/.code={\csdef{#1}{east}},
    north west/.code={\csdef{#1}{north east}},
    west/.code={\csdef{#1}{north}},
    south west/.code={\csdef{#1}{north west}},
}
\newcommand{\ctikzext@@RotateAnchor}[2]{\pgfkeys{\ctikzext@@RPath,#1={#2}}}



\def\ctikzext@@AutoRPath{/tikz/QuadKeys/Anchor Auto +90 Rotation}
\pgfkeys{\ctikzext@@AutoRPath/.is family}
\pgfkeys{\ctikzext@@AutoRPath,
    east/.code={\csdef{#1}{south}},
    west/.code={\csdef{#1}{north}},    
    south west/.code={\csdef{#1}{south west}},
    south east/.code={\csdef{#1}{north east}},
    south/.code={\csdef{#1}{west}},
    north/.code={\csdef{#1}{east}},
    north east/.code={\csdef{#1}{north east}},
    north west/.code={\csdef{#1}{south west}},
}
\newcommand{\ctikzext@@AutoRotateAnchor}[2]{\pgfkeys{\ctikzext@@AutoRPath,#1={#2}}}


%
\def\ctikzext@@TPath{/tikz/QuadKeys/Translation}
\pgfkeys{\ctikzext@@TPath/.is family}
\pgfkeys{\ctikzext@@TPath,
    setdefault/.style={#1/.code={\csdef{##1}{#1}}},
    setdefault/.list={south west,south east,north west,north east,west,east,top left,top right,bottom left,bottom right,left,right},
    set/.style 2 args={#1/.code={\csdef{##1}{#2}}},
    .unknown/.code={\csdef{#1}{\pgfkeyscurrentname}},
} 
   
%%%
%%%
%%% pgf hackery, well, extention   

\pgfkeys{/pgf/text/.cd,
    top left/.style={/pgf/text/.cd,top,left},
    top right/.style={/pgf/text/.cd,top,right},
    bottom left/.style={/pgf/text/.cd,bottom,left},
    bottom right/.style={/pgf/text/.cd,bottom,right},
}   
    
%
\tikzset{Quad compact/.style={Quad shape,QuadKeys,half base width=\pgf@circ@Rlen}}
\tikzset{BB/.style={BB shape,QuadKeys,half base width=\pgf@circ@Rlen}}
\tikzset{Black Box/.style={BB shape,QuadKeys,half base width=\pgf@circ@Rlen}}
\tikzset{Norton/.style={NortonBB shape,QuadKeys,round sources,half base width=\pgf@circ@Rlen}}
\tikzset{Thevenin/.style={TheveninBB shape,QuadKeys,round sources,half base width=\pgf@circ@Rlen}}
\tikzset{Quad/.style={Quad shape,QuadKeys}}
\tikzset{Quad Z/.style={Quad Z shape,QuadKeys}}
\tikzset{Quad Y/.style={Quad Y shape,QuadKeys}}
\tikzset{Quad G/.style={Quad G shape,QuadKeys}}
\tikzset{Quad H/.style={Quad H shape,QuadKeys}}

%%
%% These DO work, but be careful: the node gets a name only if <name> key is defined.
%%
\tikzset{ToQuad/.style={to path={node[Quad,outer x fit={\tikztostart}{\tikztotarget}](\ctikzext@@ValueofQuadKey{name}){}},QuadKeys}}
\tikzset{ToQuad Z/.style={to path={node[Quad Z,outer x fit={\tikztostart}{\tikztotarget}](\ctikzext@@ValueofQuadKey{name}){}},QuadKeys}}
\tikzset{ToQuad Y/.style={to path={node[Quad Y,outer x fit={\tikztostart}{\tikztotarget}](\ctikzext@@ValueofQuadKey{name}){}},QuadKeys}}
\tikzset{ToQuad G/.style={to path={node[Quad G,outer x fit={\tikztostart}{\tikztotarget}](\ctikzext@@ValueofQuadKey{name}){}},QuadKeys}}
\tikzset{ToQuad H/.style={to path={node[Quad H,outer x fit={\tikztostart}{\tikztotarget}](\ctikzext@@ValueofQuadKey{name}){}},QuadKeys}}

\pgfkeys{\ctikzext@@KeysPath,
    %.unknown/.code={\let\searchname=\pgfkeyscurrentname%
    %                \pgfkeysalso{/tikz/\searchname=#1}},
    .search also={/tikz},      
    none/.initial={}, %% this is a 'hack' for Thevenin/Norton ('control variable')   
    thickness/.initial=2,       
    half base width/.initial=2\pgf@circ@Rlen,%
    base width/.code={%
        \tikzmath{real \Xa;
          \Xa = 0.5*abs(#1);
        }
        \pgfkeysalso{\ctikzext@@KeysPath/half base width=\Xa}
    },
    name/.initial={},
    height ext/.initial=4\pgf@circ@Rlen/14,%
    height ext+/.style={height ext={4\pgf@circ@Rlen/14 + #1}},%
    height/.initial=\pgf@circ@Rlen,%
    half base height/.initial=10\pgf@circ@Rlen/14,%
    base height/.code={%
        \tikzmath{real \Xa;
          \Xa = 0.5*abs(#1);
        }
        \pgfkeysalso{\ctikzext@@KeysPath/half base height=\Xa}
    },
    inner ext/.initial=2\pgf@circ@Rlen/14,%
    outer ext/.initial=5\pgf@circ@Rlen/14,
    source radius/.initial=0.3\pgf@circ@Rlen,%
    @round sources/.code={\toggletrue{ctikzext@@toggle@roundsources}},
    round sources/.style={@round sources},
    @control sources/.code={\togglefalse{ctikzext@@toggle@roundsources}},
    control sources/.style={@control sources},
    minussign len/.initial=1.0\pgf@circ@Rlen/14,%
    plussign len/.initial=1.1\pgf@circ@Rlen/14,%
    tip len/.initial=4pt,
    tip type/.is choice,
    tip type/bezier/.code={\toggletrue{ctikzext@@toggle@beziertip}},
    tip type/triangle/.code={\togglefalse{ctikzext@@toggle@beziertip}},
    Y11/.initial=$Y_{11}$, Y12/.initial=$Y_{12}$, Y21/.initial=$Y_{21}$, Y22/.initial=$Y_{22}$,
    Z11/.initial=$Z_{11}$, Z12/.initial=$Z_{12}$, Z21/.initial=$Z_{21}$, Z22/.initial=$Z_{22}$,
    H11/.initial=$H_{11}$, H12/.initial=$H_{12}$, H21/.initial=$H_{21}$, H22/.initial=$H_{22}$,
    G11/.initial=$G_{11}$, G12/.initial=$G_{12}$, G21/.initial=$G_{21}$, G22/.initial=$G_{22}$,
     I1/.initial=$I_1$,     I2/.initial=$I_2$,     V1/.initial=$V_1$,     V2/.initial=$V_2$,
     In/.initial=$I_N$,     Yn/.initial=$Y_N$,    Vth/.initial=$V_{th}$, Zth/.initial=$Z_{th}$,
    zero/.initial=0,
    outer sep/.initial=1.5pt,
    inner sep/.initial=1pt,
    @inner ocirc/.code={\toggletrue{ctikzext@@toggle@innerocirc}},
    inner ocirc/.style={@inner ocirc},
    @outer ocirc/.code={\toggletrue{ctikzext@@toggle@outerocirc}},
    outer ocirc/.style={@outer ocirc},
    @invert/.code={\toggletrue{ctikzext@@toggle@inverted}},
    invert/.style={%
        /tikz/xscale=-1,
        @invert,
        \ctikzext@@TPath,
%        set={south west}{south east},
%        set={south east}{south west},
%        set={north west}{north east},
%        set={north east}{north west},        
%        set={west}{east},
%        set={east}{west},        
        set={bottom left}{bottom right},
        set={bottom right}{bottom left},
        set={top left}{top right},
        set={top right}{top left},        
        set={left}{right},
        set={right}{left}, 
        \ctikzext@@KeysPath,       
    },
    @generic/.code={\toggletrue{ctikzext@@toggle@generic}},
    generic/.style={@generic},
    compact/.style={half base width=\pgf@circ@Rlen},
    @alternate/.code={\toggletrue{ctikzext@@toggle@alternate}},
    alt/.style={@alternate},
    opt/.style={@alternate},
    inner x fit/.code 2 args={%
        \tikzmath{coordinate \Xa , \Xb;
          \Xa = (#1);
          \Xb = (#2);
          \Xdiff = 0.5*abs(\Xbx - \Xax) + \ctikzext@@ValueofQuadKey{inner ext};
        }
        \pgfkeysalso{\ctikzext@@KeysPath/half base width=\Xdiff}
      },
    outer x fit/.code 2 args={%
        \tikzmath{coordinate \Xa , \Xb;
          \Xa = (#1);
          \Xb = (#2);
          \Xdiff = 0.5*abs(\Xbx - \Xax) - \ctikzext@@ValueofQuadKey{outer ext};
        }
        \pgfkeysalso{\ctikzext@@KeysPath/half base width=\Xdiff}
      } ,
    y fit/.code 2 args={%
        \tikzmath{coordinate \Xa , \Xb;
          \Xa = (#1);
          \Xb = (#2);
          \Ydiff = 0.5*abs(\Xby - \Xay);
        }
        \pgfkeysalso{\ctikzext@@KeysPath/half base height=\Ydiff}
      } ,  
}

\pgfkeys{\ctikzext@@KeysPath,
    setlabelscmd/.style={%
        #1 N anchor/.style={}, 
        #1 T anchor/.style={}, 
        #1 label pos/.style 2 args={#1 N anchor/.style={\ctikzext@@TPath,##1=####1}, #1 T anchor/.style={\ctikzext@@TPath,##2=####1},  },
        },
    setlabelscmd/.list={Z11,Z12,Z21,Z22,Y11,Y12,Y21,Y22,G11,G12,G21,G22,H11,H12,H21,H22,In,Yn,Vth,Zth},
    defaults/.style={
        Z11 label pos={south west}{top left},
        Z12 label pos={south east}{top left},
        Z21 label pos={north west}{bottom right},
        Z22 label pos={south east}{top right},
%       
        Y11 label pos={south east}{top left},
        Y12 label pos={south east}{top left},
        Y21 label pos={north west}{bottom right},
        Y22 label pos={north west}{bottom right},
%       
        G11 label pos={south east}{top left},
        G12 label pos={south east}{top left},
        G21 label pos={north west}{bottom right},
        G22 label pos={south east}{top right},
%
        H11 label pos={south west}{top left},
        H12 label pos={south east}{top left},
        H21 label pos={north west}{bottom right},
        H22 label pos={north west}{bottom right},
        %
        Yn label pos={south east}{top left},
        In label pos={south east}{top left},
        %
        Zth label pos={south west}{top left},
        Vth label pos={south east}{top left},
        %
    },
    defaults,
}

\newcommand{\ctikzext@@QuadPoints}{
		\tikzmath{
			real \x,\y;
      \x{center}=0;
      \y{center}=0;
			\x{right}=0 + \ctikzext@@ValueofQuadKey{half base width};
			\y{top}=0 +( \ctikzext@@ValueofQuadKey{half base height} +  \ctikzext@@ValueofQuadKey{height ext});
			%
			\x{left}=0 - \ctikzext@@ValueofQuadKey{half base width};
			\y{bottom}=0 -( \ctikzext@@ValueofQuadKey{half base height} +  \ctikzext@@ValueofQuadKey{height ext});
			%
			\y{innerbottom}=0 - \ctikzext@@ValueofQuadKey{half base height};
			\y{innertop}=0 + \ctikzext@@ValueofQuadKey{half base height};
			%
			\y{outerbottom}=\y{bottom} - 0.5*\ctikzext@@ValueofQuadKey{outer ext};
			\y{outertop}=\y{top} + 0.5*\ctikzext@@ValueofQuadKey{outer ext};
			%
			\x{outerleft}=\x{left} - \ctikzext@@ValueofQuadKey{outer ext};
			\x{innerleft}=\x{left} + \ctikzext@@ValueofQuadKey{inner ext};
			%
			\x{outerright}=\x{right} + \ctikzext@@ValueofQuadKey{outer ext};
			\x{innerright}=\x{right} - \ctikzext@@ValueofQuadKey{inner ext};
      %
			\x{refC}=0 - 0.4*\ctikzext@@ValueofQuadKey{half base width};
      \x{refB}=(\x{innerleft}+\x{refC})/2; %center point for Res shape
      \x{refA}=(2*\x{innerleft}+\x{refC})/3; %'center' point for Y.Res shape
			%
			\y{Tbottom}=\y{bottom} + 0.65ex;
			\x{Tinnerleft}=\x{innerleft} ;
			\y{Tinnerbottom}=\y{innerbottom} + 0.95ex;
			\x{Tinnerright}=\x{innerright};
      \x{Tcenter}=0;
      %
			\y{Ttop}=\y{top} - 0.65ex;
			\y{Tinnertop}=\y{innertop} - 0.95ex;
		}
}



\newcommand{\ctikzext@@BBPoints}{
		\tikzmath{
			real \x,\y;
      \x{center}=0;
      \y{center}=0;
			\x{right}=0 + \ctikzext@@ValueofQuadKey{half base width};
			\y{top}=0 +( \ctikzext@@ValueofQuadKey{half base height} +  \ctikzext@@ValueofQuadKey{height ext});
			%
			\x{left}=0 - \ctikzext@@ValueofQuadKey{half base width};
			\y{bottom}=0 -( \ctikzext@@ValueofQuadKey{half base height} +  \ctikzext@@ValueofQuadKey{height ext});
			%
			\y{innerbottom}=0 - \ctikzext@@ValueofQuadKey{half base height};
			\y{innertop}=0 + \ctikzext@@ValueofQuadKey{half base height};
			%
			\y{outerbottom}=\y{bottom} - 0.5*\ctikzext@@ValueofQuadKey{outer ext};
			\y{outertop}=\y{top} + 0.5*\ctikzext@@ValueofQuadKey{outer ext};
			%
			\x{outerleft}=\x{left} - \ctikzext@@ValueofQuadKey{outer ext};
			\x{innerleft}=\x{left} + \ctikzext@@ValueofQuadKey{inner ext};
			%
			\x{outerright}=\x{right} + \ctikzext@@ValueofQuadKey{outer ext};
			\x{innerright}=\x{right} - \ctikzext@@ValueofQuadKey{inner ext};
      %
			\x{refC}=0 + 0.3*\ctikzext@@ValueofQuadKey{half base width};
      \x{refB}=(\x{innerleft}+\x{refC})/2; %center point for Res shape
      \x{refA}=(2*\x{innerleft}+\x{refC})/3; %'center' point for Y.Res shape
			%
			\y{Tbottom}=\y{bottom} + 0.65ex;
			\x{Tinnerleft}=\x{innerleft} ;
			\y{Tinnerbottom}=\y{innerbottom} + 0.95ex;
			\x{Tinnerright}=\x{innerright};
      \x{Tcenter}=0;
      %
			\y{Ttop}=\y{top} - 0.65ex;
			\y{Tinnertop}=\y{innertop} - 0.95ex;
		}
}



\newcommand{\ctikzext@@CondDraw}[3]{
	\IfDecimal{\ctikzext@@ValueofQuadKey{#1}}{
		\ifnumequal{0+\ctikzext@@ValueofQuadKey{#1}}{0}{%
			#2
		}{%
			#3
		}
	}{#3}
}

\newcommand{\ctikzext@@Zdraw}[5]{
  \ctikzext@@CondDraw{#1}{%
		\pgfnode{Shadow #2}{#3}{}{\tikz@fig@name-#1}{\pgfusepath{discard}}
		\pgfpathmoveto{\pgfpointanchor{\tikz@fig@name-#1}{#4}}
		\pgfpathlineto{\pgfpointanchor{\tikz@fig@name-#1}{#5}}
		\pgfusepath{stroke}
  }{%
		\pgfnode{#2}{#3}{}{\tikz@fig@name-#1}{\pgfusepath{stroke}}
  }
}


\newtoggle{ctikzext@@toggle@auxA}
\newtoggle{ctikzext@@toggle@auxB}
%
% #1->z11/z22 (res)
% #2->z12/z21 (vsource)
% #3 -> 'control source' I1/I2/V1/V2
% #4->"-" minus signal !!! for B side
%
\newcommand{\ctikzext@@Zside}[4]{
		\togglefalse{ctikzext@@toggle@auxA}
		\IfDecimal{\ctikzext@@ValueofQuadKey{#1}}{
			\ifnumequal{0+\ctikzext@@ValueofQuadKey{#1}}{0}{
			\toggletrue{ctikzext@@toggle@auxA}}
			}{}{
		}
		\togglefalse{ctikzext@@toggle@auxB}
		\IfDecimal{\ctikzext@@ValueofQuadKey{#2}}{
			\ifnumequal{0+\ctikzext@@ValueofQuadKey{#2}}{0}{
			\toggletrue{ctikzext@@toggle@auxB}}
			}{}{
		}
		\ifboolexpr{togl{ctikzext@@toggle@alternate} and ( togl{ctikzext@@toggle@auxA} or togl{ctikzext@@toggle@auxB})}{
			\iftoggle{ctikzext@@toggle@auxA}{
				{
					\pgftransformshift{\pgfpoint{#4\x{refB}}{0}}
					\ctikzext@@Zdraw{#2}{Vsource shape}{center}{north}{south}
				}
				{
					\pgfpathmoveto{\pgfpoint{#4\x{innerleft}}{\y{innertop}}}
					\pgfpathlineto{\pgfpoint{#4\x{refB}}{\y{innertop}}}
					\pgfpathlineto{\pgfpointanchor{\tikz@fig@name-#2}{north}}
					\pgfpathmoveto{\pgfpointanchor{\tikz@fig@name-#2}{south}}
					\pgfpathlineto{\pgfpoint{#4\x{refB}}{\y{innerbottom}}}
					\pgfpathlineto{\pgfpoint{#4\x{innerleft}}{\y{innerbottom}}}
					\pgfusepath{stroke}
				}
			}{
				{
					\pgftransformshift{\pgfpoint{#4\x{refB}}{0}}
					\pgftransformrotate{90}  %%% was #490
					\ctikzext@@Zdraw{#1}{Res shape}{center}{west}{east}
          \pgfusepath{stroke}
				}
				{
					\pgfpathmoveto{\pgfpoint{#4\x{innerleft}}{\y{innertop}}}
					\pgfpathlineto{\pgfpoint{#4\x{refB}}{\y{innertop}}}
					\pgfpathlineto{\pgfpointanchor{\tikz@fig@name-#1}{east}}
					\pgfpathmoveto{\pgfpointanchor{\tikz@fig@name-#1}{west}}
					\pgfpathlineto{\pgfpoint{#4\x{refB}}{\y{innerbottom}}}
					\pgfpathlineto{\pgfpoint{#4\x{innerleft}}{\y{innerbottom}}}
					\pgfusepath{stroke}
				}
			}
		}{
			{
        \pgftransformshift{\pgfpoint{#4\x{refB}}{\y{innertop}}}
        \ctikzext@@Zdraw{#1}{Res shape}{center}{west}{east}
        %\ctikzext@@Zdraw{#1}{resistorshape}{center}{west}{east}
			}
			{
				\pgftransformshift{\pgfpoint{#4\x{refC}}{0}}
				\ctikzext@@Zdraw{#2}{Vsource shape}{center}{north}{south}
			}
			{
        \pgfpathmoveto{\pgfpoint{#4\x{innerleft}}{\y{innertop}}}
        \ifnumequal{#41}{-1}{%
          \pgfpathlineto{\pgfpointanchor{\tikz@fig@name-#1}{east}}
  				\pgfpathmoveto{\pgfpointanchor{\tikz@fig@name-#1}{west}}
        }{%
          \pgfpathlineto{\pgfpointanchor{\tikz@fig@name-#1}{west}}
  				\pgfpathmoveto{\pgfpointanchor{\tikz@fig@name-#1}{east}}
        }
				\pgfpathlineto{\pgfpoint{#4\x{refC}}{\y{innertop}}}
				\pgfpathlineto{\pgfpointanchor{\tikz@fig@name-#2}{north}}
				\pgfpathmoveto{\pgfpointanchor{\tikz@fig@name-#2}{south}}
				\pgfpathlineto{\pgfpoint{#4\x{refC}}{\y{innerbottom}}}
				\pgfpathlineto{\pgfpoint{#4\x{innerleft}}{\y{innerbottom}}}
				\pgfusepath{stroke}
			}
		}
%
        \ctikzext@@QuadGetAnchor{#2 N anchor}{ctikzext@@NanchorB}
        \ctikzext@@QuadGetAnchor{#1 T anchor}{ctikzext@@TanchorA}
        \ctikzext@@QuadGetAnchor{#2 T anchor}{ctikzext@@TanchorB}
     		\ifboolexpr{togl{ctikzext@@toggle@alternate} and togl{ctikzext@@toggle@auxB}}{%
          \ctikzext@@QuadGetAnchor{#1 N anchor}{ctikzext@@NanchorAx}
          \ctikzext@@AutoRotateAnchor{\ctikzext@@NanchorAx}{ctikzext@@NanchorA}
        }{%
          \ctikzext@@QuadGetAnchor{#1 N anchor}{ctikzext@@NanchorA}
        }
        {       
        	\pgftransformresetnontranslations
        	\ctikzext@@CondDraw{#1}{}{\pgftext[\ctikzext@@TanchorA,at={\pgfpointanchor{\tikz@fig@name-#1}{\ctikzext@@NanchorA}}]{\ctikzext@@ValueofQuadKey{#1}}}
        	\ctikzext@@CondDraw{#2}{}{\pgftext[\ctikzext@@TanchorB,at={\pgfpointanchor{\tikz@fig@name-#2}{\ctikzext@@NanchorB}}]{\ctikzext@@ValueofQuadKey{#2}\ctikzext@@ValueofQuadKey{#3}}}
        }
%
}

\newcommand{\ctikzext@@Ydraw}[3]{
  \ctikzext@@CondDraw{#1}{%
    \pgfnode{Shadow #2}{#3}{}{\tikz@fig@name-#1}{\pgfusepath{discard}}
  }{%
    \pgfnode{#2}{#3}{}{\tikz@fig@name-#1}{\pgfusepath{stroke}}
  }
}

% #1 Isource UP/DWN
% #2->y11/y22 (res)
% #3->y12/y21 (isource)
% #4 -> 'control source' I1/I2/V1/V2
% #5->"-" minus signal !!! for B side
%
\newcommand{\ctikzext@@Yside}[5][IsourceDOWN shape]{
		\togglefalse{ctikzext@@toggle@auxA}
		\IfDecimal{\ctikzext@@ValueofQuadKey{#2}}{
			\ifnumequal{0+\ctikzext@@ValueofQuadKey{#2}}{0}{
				\toggletrue{ctikzext@@toggle@auxA}}
			}{}{
		}
		\togglefalse{ctikzext@@toggle@auxB}
		\IfDecimal{\ctikzext@@ValueofQuadKey{#3}}{
			\ifnumequal{0+\ctikzext@@ValueofQuadKey{#3}}{0}{
				\toggletrue{ctikzext@@toggle@auxB}}
			}{}{
		}
		\ifboolexpr{togl{ctikzext@@toggle@alternate} and ( togl{ctikzext@@toggle@auxA} or togl{ctikzext@@toggle@auxB})}{
			\tikzmath{
				\x{20} = \x{refB};
				\x{21} = \x{refB};
			}
		}{
			\tikzmath{
				\x{20} = \x{refA};
				\x{21} = \x{refC};
			}
		}
%
		{
			\pgftransformshift{\pgfpoint{#5\x{20}}{0}}
			\pgftransformrotate{90}  %%% was {#590}
			\ctikzext@@Ydraw{#2}{Res shape}{center}
		}
		\ctikzext@@CondDraw{#2}{}{
			\pgfpathmoveto{\pgfpoint{#5\x{innerleft}}{\y{innertop}}}
			\pgfpathlineto{\pgfpoint{#5\x{20}}{\y{innertop}}}
			\pgfpathlineto{\pgfpointanchor{\tikz@fig@name-#2}{east}}
			\pgfpathmoveto{\pgfpointanchor{\tikz@fig@name-#2}{west}}
			\pgfpathlineto{\pgfpoint{#5\x{20}}{\y{innerbottom}}}
			\pgfpathlineto{\pgfpoint{#5\x{innerleft}}{\y{innerbottom}}}
			\pgfusepath{stroke}
		}
    {
			\pgftransformshift{\pgfpoint{#5\x{21}}{0}}
      \ctikzext@@Ydraw{#3}{#1}{center}
    }
		\ctikzext@@CondDraw{#3}{}{
			\pgfpathmoveto{\pgfpoint{#5\x{innerleft}}{\y{innertop}}}
			\pgfpathlineto{\pgfpoint{#5\x{refA}}{\y{innertop}}}
			\pgfpathlineto{\pgfpoint{#5\x{21}}{\y{innertop}}}
			\pgfpathlineto{\pgfpointanchor{\tikz@fig@name-#3}{north}}
			\pgfpathmoveto{\pgfpointanchor{\tikz@fig@name-#3}{south}}
			\pgfpathlineto{\pgfpoint{#5\x{21}}{\y{innerbottom}}}
			\pgfpathlineto{\pgfpoint{#5\x{innerleft}}{\y{innerbottom}}}
			\pgfusepath{stroke}
		}
        \ctikzext@@QuadGetAnchor{#2 N anchor}{ctikzext@@NanchorAx}
        \ctikzext@@QuadGetAnchor{#3 N anchor}{ctikzext@@NanchorB}
        \ctikzext@@QuadGetAnchor{#2 T anchor}{ctikzext@@TanchorA}
        \ctikzext@@QuadGetAnchor{#3 T anchor}{ctikzext@@TanchorB}
        \ctikzext@@RotateAnchor{\ctikzext@@NanchorAx}{ctikzext@@NanchorA}
        {
        	\pgftransformresetnontranslations
        	\ctikzext@@CondDraw{#2}{}{\pgftext[\ctikzext@@TanchorA,at={\pgfpointanchor{\tikz@fig@name-#2}{\ctikzext@@NanchorA}}]{\ctikzext@@ValueofQuadKey{#2}}}
        	\ctikzext@@CondDraw{#3}{}{\pgftext[\ctikzext@@TanchorB,at={\pgfpointanchor{\tikz@fig@name-#3}{\ctikzext@@NanchorB}}]{\ctikzext@@ValueofQuadKey{#3}\ctikzext@@ValueofQuadKey{#4}}}
        }

}


\newcommand{\ctikzext@@ResPoints}{
		\tikzmath{
			real \x,\y;
      \x{center}=0;
      \y{center}=0;
      \x{left}=-\ctikzvalof{bipoles/resistor/width}\pgf@circ@Rlen/2;
      \x{right}=\ctikzvalof{bipoles/resistor/width}\pgf@circ@Rlen/2;
			\y{top}=+\ctikzvalof{bipoles/resistor/height}\pgf@circ@Rlen/2;
			\y{bottom}=-\ctikzvalof{bipoles/resistor/height}\pgf@circ@Rlen/2;
      \x{step}=\ctikzvalof{bipoles/resistor/width}\pgf@circ@Rlen/12;
      \y{step}=\ctikzvalof{bipoles/resistor/height}\pgf@circ@Rlen/2;
      %
      \x{Tcenter}=0;
      \y{Tcenter}=0;
			\y{Ttop}=+\ctikzvalof{bipoles/resistor/height}\pgf@circ@Rlen/2 +\ctikzext@@ValueofQuadKey{outer sep};
			\y{Tbottom}=-\y{Ttop};
			%
			\x{Tright}=+\ctikzvalof{bipoles/resistor/width}\pgf@circ@Rlen/2 +\ctikzext@@ValueofQuadKey{outer sep};
			\x{Tleft}=-\x{Tright};
		}
}

\newcommand{\ctikzext@@ResBaseAnchors}[1]{
	\anchor{center}{\centerpoint}
	\savedanchor\centerpoint{%
    #1
    \pgfpoint{\x{center}}{\y{center}}
  }
	\anchor{text}{
    #1
    \pgfpoint{\x{Tcenter}}{\y{Ttop}}
	}
	\anchor{west}{\west}
	\savedanchor{\west}{%
    #1
    \pgfpoint{\x{left}}{\y{center}}
	}
	\anchor{east}{\east}
	\savedanchor{\east}{%
    #1
    \pgfpoint{\x{right}}{\y{center}}
	}
	\anchor{north}{\north}
	\savedanchor{\north}{%
    #1
    \pgfpoint{\x{Tcenter}}{\y{Ttop}}
	}
	\anchor{south}{\south}
	\savedanchor{\south}{%
    #1
    \pgfpoint{\x{Tcenter}}{\y{Tbottom}}
	}
	\anchor{north west}{\northwest}%
	\savedanchor{\northwest}{%
    #1
    \pgfpoint{\x{Tleft}}{\y{Ttop}}
	}
	\anchor{north east}{\northeast}%
	\savedanchor{\northeast}{%
    #1
    \pgfpoint{\x{Tright}}{\y{Ttop}}
	}
	\anchor{south west}{\southwest}%
	\savedanchor{\southwest}{%
    #1
    \pgfpoint{\x{Tleft}}{\y{Tbottom}}
	}
	\anchor{south east}{\southeast}%
	\savedanchor{\southeast}{%
    #1
    \pgfpoint{\x{Tright}}{\y{Tbottom}}
	}
}



\pgfdeclareshape{Res shape}{
  \ctikzext@@ResBaseAnchors{\ctikzext@@ResPoints}
	\behindbackgroundpath{
    \ctikzext@@ResPoints
    \pgfsetxvec{\pgfpoint{\x{step}}{0}}
		\pgfsetyvec{\pgfpoint{0}{\y{step}}}
  \begin{pgfscope}
    \pgfsetlinewidth{\ctikzext@@ValueofQuadKey{thickness}\pgflinewidth}
    \pgfsetbeveljoin
		\iftoggle{ctikzext@@toggle@generic}{
			\pgfpathmoveto{\pgfpointxy{-6}{-1}}
			\pgfpathlineto{\pgfpointxy{-6}{1}}
			\pgfpathlineto{\pgfpointxy{6}{1}}
			\pgfpathlineto{\pgfpointxy{6}{-1}}
			\pgfpathlineto{\pgfpointxy{-6}{-1}}
		}{
			\pgfpathmoveto{\pgfpointxy{-6}{0}}
			\pgfpathlineto{\pgfpointxy{-5}{1}}
			\pgfpathlineto{\pgfpointxy{-3}{-1}}
			\pgfpathlineto{\pgfpointxy{-1}{1}}
			\pgfpathlineto{\pgfpointxy{1}{-1}}
			\pgfpathlineto{\pgfpointxy{3}{1}}
			\pgfpathlineto{\pgfpointxy{5}{-1}}
			\pgfpathlineto{\pgfpointxy{6}{0}}
		}
    \pgfusepath{stroke}
  \end{pgfscope}
%    \pgfsetlinewidth{\orglinewidth}
	}
	\backgroundpath{}
}


%%%%%%%%%%%
%%%%%%%%%%%
%%%%% Shadow Res shape => do nothing but defines anchors
%%%%%%%%%%%
%%%%%%%%%%%

\pgfdeclareshape{Shadow Res shape}{
	\inheritsavedanchors[from=Res shape]
	\foreach \anchor in {north,north west,north east,center,west,east,
	,south,south west,south east,text}{%
		\inheritanchor[from=Res shape]{\anchor}}
	\backgroundpath{}
}



\newcommand{\ctikzext@@SourcePoints}{
		\tikzmath{
			real \x,\y;
      \x{center}=0;
      \y{center}=0;
      \x{left}=-\ctikzext@@ValueofQuadKey{source radius};
      \x{right}=\ctikzext@@ValueofQuadKey{source radius};
			\y{top}=+\ctikzext@@ValueofQuadKey{source radius};
			\y{bottom}=-\ctikzext@@ValueofQuadKey{source radius};
      %
      \x{Tcenter}=0;
      \y{Tcenter}=0;
			\y{Tmiddletop}=+cos(45)*(\ctikzext@@ValueofQuadKey{source radius}+\ctikzext@@ValueofQuadKey{outer sep});
			\y{Tmiddlebottom}=-\y{Tmiddletop};
			%
			\x{Tmiddleright}=+cos(45)*(\ctikzext@@ValueofQuadKey{source radius}+\ctikzext@@ValueofQuadKey{outer sep});
			\x{Tmiddleleft}=-\x{Tmiddleright};
		}
}



%%%%%%%%%%%
%%%%%%%%%%%
%%%%% Base source shape
%%%%%%%%%%%
%%%%%%%%%%%

\newcommand{\ctikzext@@SourceBaseAnchors}[1]{
	\savedanchor\centerpoint{
		\pgfpoint{0}{0}
	}
	\anchor{center}{\centerpoint}
	\anchor{text}{\text}%
	\savedanchor{\text}{%
    #1
    \pgfpoint{\x{Tmiddleright}}{\y{Tmiddletop}}
	}
	\anchor{west}{\west}%
	\savedanchor{\west}{%
    #1
    \pgfpoint{\x{left}}{\y{center}}
	}
	\anchor{east}{\east}%
	\savedanchor{\east}{%
    #1
    \pgfpoint{\x{right}}{\y{center}}
	}
	\anchor{north}{\north}%
	\savedanchor{\north}{%
    #1
    \pgfpoint{\x{center}}{\y{top}}
	}
	\anchor{south}{\south}%
	\savedanchor{\south}{%
    #1
    \pgfpoint{\x{center}}{\y{bottom}}
	}
	\anchor{north west}{\northwest}%
	\savedanchor{\northwest}{%
    #1
    \pgfpoint{\x{Tmiddleleft}}{\y{Tmiddletop}}
	}
	\anchor{north east}{\northeast}%
	\savedanchor{\northeast}{%
    #1
    \pgfpoint{\x{Tmiddleright}}{\y{Tmiddletop}}
	}
	\anchor{south west}{\southwest}%
	\savedanchor{\southwest}{%
    #1
    \pgfpoint{\x{Tmiddleright}}{\y{Tmiddlebottom}}
	}
	\anchor{south east}{\southeast}%
	\savedanchor{\southeast}{%
    #1
    \pgfpoint{\x{Tmiddleright}}{\y{Tmiddlebottom}}
	}
}

\pgfdeclareshape{Base source shape}{
  \ctikzext@@SourceBaseAnchors{\ctikzext@@SourcePoints}
	\backgroundpath{}
		\pgfsetroundcap
		\pgfpathcircle{\pgfpoint{0}{0}}{\ctikzext@@ValueofQuadKey{source radius}}
	}


%%%%%%%%%%%
%%%%%%%%%%%
%%%%% Vsource shape
%%%%%%%%%%%
%%%%%%%%%%%

\pgfdeclareshape{Vsource shape}{
	\inheritsavedanchors[from=Base source shape]
	\foreach \anchor in {north,north west,north east,center,west,east,
	,south,south west,south east,text}{%
		\inheritanchor[from=Base source shape]{\anchor}}
	\backgroundpath{
		\pgfsetroundcap
    \begin{pgfscope}
      \ctikzext@@SourcePoints
      \pgfsetbeveljoin
      \pgfsetlinewidth{\ctikzext@@ValueofQuadKey{thickness}\pgflinewidth}
      \iftoggle{ctikzext@@toggle@roundsources}{
     		\pgfpathcircle{\pgfpoint{0}{0}}{\ctikzext@@ValueofQuadKey{source radius}}
      }{
        \pgfpathmoveto{\pgfpoint{\x{center}}{\y{top}}}
        \pgfpathlineto{\pgfpoint{\x{right}}{\y{center}}}
        \pgfpathlineto{\pgfpoint{\x{center}}{\y{bottom}}}
        \pgfpathlineto{\pgfpoint{\x{left}}{\y{center}}}
        \pgfpathlineto{\pgfpoint{\x{center}}{\y{top}}}
      }
      \pgfusepath{stroke}
    \end{pgfscope}
    \ctikzext@@minussignat[\ctikzext@@ValueofQuadKey{minussign len}]{0}{-0.4*\ctikzext@@ValueofQuadKey{source radius}}
    \ctikzext@@plussignat[\ctikzext@@ValueofQuadKey{plussign len}]{0}{0.4*\ctikzext@@ValueofQuadKey{source radius}}
    \pgfusepath{stroke}
	}
}

%%%%%%%%%%%
%%%%%%%%%%%
%%%%% Shadow Vsource shape => do nothing but defines anchors
%%%%%%%%%%%
%%%%%%%%%%%

\pgfdeclareshape{Shadow Vsource shape}{
	\inheritsavedanchors[from=Base source shape]
	\foreach \anchor in {north,north west,north east,center,west,east,
	,south,south west,south east,text}{%
		\inheritanchor[from=Base source shape]{\anchor}}
	\backgroundpath{}
}

%%%%%%%%%%%
%%%%%%%%%%%
%%%%% IsourceDOWN shape
%%%%%%%%%%%
%%%%%%%%%%%

\pgfdeclareshape{IsourceDOWN shape}{
	\inheritsavedanchors[from=Base source shape]
	\foreach \anchor in {north,north west,north east,center,west,east,
	,south,south west,south east,text}{%
		\inheritanchor[from=Base source shape]{\anchor}}
	\backgroundpath{
		\begin{pgfscope}
      \ctikzext@@SourcePoints
      \pgfsetlinewidth{\ctikzext@@ValueofQuadKey{thickness}\pgflinewidth}
  		\pgfsetroundcap
      \iftoggle{ctikzext@@toggle@roundsources}{
     		\pgfpathcircle{\pgfpoint{0}{0}}{\ctikzext@@ValueofQuadKey{source radius}}
      }{
        \pgfpathmoveto{\pgfpoint{\x{center}}{\y{top}}}
        \pgfpathlineto{\pgfpoint{\x{right}}{\y{center}}}
        \pgfpathlineto{\pgfpoint{\x{center}}{\y{bottom}}}
        \pgfpathlineto{\pgfpoint{\x{left}}{\y{center}}}
        \pgfpathlineto{\pgfpoint{\x{center}}{\y{top}}}
      }
  		\pgfpathmoveto{\pgfpoint{0}{0.7*\ctikzext@@ValueofQuadKey{source radius}}}
  		\pgfpathlineto{\pgfpoint{0}{-0.7*\ctikzext@@ValueofQuadKey{source radius}}}
  %
      \pgfusepath{stroke}
      \ctikzext@@arrowtipat{-90}{0}{-0.7*\ctikzext@@ValueofQuadKey{source radius}+\ctikzext@@ValueofQuadKey{tip len}}
      \pgfusepath{stroke,fill}
		\end{pgfscope}
	}}

%%%%%%%%%%%
%%%%%%%%%%%
%%%%% Shadow IsourceDOWN shape => do nothing but defines anchors
%%%%%%%%%%%
%%%%%%%%%%%

\pgfdeclareshape{Shadow IsourceDOWN shape}{
	\inheritsavedanchors[from=Base source shape]
	\foreach \anchor in {north,north west,north east,center,west,east,
	,south,south west,south east,text}{%
		\inheritanchor[from=Base source shape]{\anchor}}
	\backgroundpath{}
}


%%%%%%%%%%%
%%%%%%%%%%%
%%%%% IsourceUP shape
%%%%%%%%%%%
%%%%%%%%%%%

\pgfdeclareshape{IsourceUP shape}{
	\inheritsavedanchors[from=Base source shape]
	\foreach \anchor in {north,north west,north east,center,west,east,
	,south,south west,south east,text}{%
		\inheritanchor[from=Base source shape]{\anchor}}
	\backgroundpath{
		\begin{pgfscope}
      \ctikzext@@SourcePoints
      \pgfsetlinewidth{\ctikzext@@ValueofQuadKey{thickness}\pgflinewidth}
  		\pgfsetroundcap
      \iftoggle{ctikzext@@toggle@roundsources}{
     		\pgfpathcircle{\pgfpoint{0}{0}}{\ctikzext@@ValueofQuadKey{source radius}}
      }{
        \pgfpathmoveto{\pgfpoint{\x{center}}{\y{top}}}
        \pgfpathlineto{\pgfpoint{\x{right}}{\y{center}}}
        \pgfpathlineto{\pgfpoint{\x{center}}{\y{bottom}}}
        \pgfpathlineto{\pgfpoint{\x{left}}{\y{center}}}
        \pgfpathlineto{\pgfpoint{\x{center}}{\y{top}}}
      }
  		\pgfpathmoveto{\pgfpoint{0}{0.7*\ctikzext@@ValueofQuadKey{source radius}}}
  		\pgfpathlineto{\pgfpoint{0}{-0.7*\ctikzext@@ValueofQuadKey{source radius}}}
  %
      \pgfusepath{stroke}
      \ctikzext@@arrowtipat{90}{0}{0.7*\ctikzext@@ValueofQuadKey{source radius}-\ctikzext@@ValueofQuadKey{tip len}}
      \pgfusepath{stroke,fill}
		\end{pgfscope}
	}
}

%%%%%%%%%%%
%%%%%%%%%%%
%%%%% Shadow IsourceUP shape => do nothing but defines anchors
%%%%%%%%%%%
%%%%%%%%%%%

\pgfdeclareshape{Shadow IsourceUP shape}{
	\inheritsavedanchors[from=Base source shape]
	\foreach \anchor in {north,north west,north east,center,west,east,
	,south,south west,south east,text}{%
		\inheritanchor[from=Base source shape]{\anchor}}
	\backgroundpath{}
}


\newcommand{\ctikzext@@arrowtipat}[3]{
  { 
    \pgftransformshift{\pgfpoint{#2}{#3}}
    \pgftransformscale{\ctikzext@@ValueofQuadKey{tip len}}
    \pgftransformrotate{#1}%\pgfsetlinewidth{\ctikzext@@ValueofQuadKey{thickness}\pgflinewidth}
    \iftoggle{ctikzext@@toggle@beziertip}{   
        %% bezier version  
        \pgfsetroundcap\pgfsetbeveljoin%\pgfsetlinewidth{\ctikzext@@ValueofQuadKey{thickness}\pgflinewidth}
        \pgfpathmoveto{\pgfpoint{1}{0}}
        \pgfpathcurveto{\pgfpoint{0.3}{0.125}}{\pgfpoint{0.3}{0.125}}{\pgfpoint{0}{0.4}}
        \pgfpathcurveto{\pgfpoint{0.15}{0}}{\pgfpoint{0.15}{0}}{\pgfpoint{0}{-0.4}}
        \pgfpathcurveto{\pgfpoint{0.3}{-0.125}}{\pgfpoint{0.3}{-0.125}}{\pgfpoint{1}{0}}
    }{  %% simple triangle version
        \pgfsetroundcap
        \pgfpathmoveto{\pgfpoint{1}{0}}
        \pgfpathlineto{\pgfpoint{0}{0.45}}
        \pgfpathlineto{\pgfpoint{0}{-0.45}}
        \pgfpathlineto{\pgfpoint{1}{0}}
    }
  }
}

%%%%%%%%%%%
%%%%%%%%%%%
%%%%% Quad
%%%%%%%%%%%
%%%%%%%%%%%


\newcommand{\ctikzext@@QuadBaseAnchors}[1]{
	\savedanchor\centerpoint{
		\pgfpoint{0}{0}
	}
	\anchor{center}{\centerpoint}
	\anchor{text}{\text}%
	\savedanchor{\text}{%
		#1
		\pgfpoint{\x{Tinnerleft}}{\y{Tbottom}}
	}
	\anchor{bottom left}{\bottomleft}
	\savedanchor{\bottomleft}{%
		#1
		\pgfpoint{\x{Tinnerleft}}{\y{Tbottom}}
	}
	\anchor{bottom center}{\bottomcenter}
	\savedanchor{\bottomcenter}{%
		#1
		\pgfpoint{0}{\y{Tbottom}}
	}
	\anchor{bottom right}{\bottomright}
	\savedanchor{\bottomright}{%
		#1
		\pgfpoint{\x{Tinnerright}}{\y{Tbottom}}
	}
	\anchor{lower left}{\lowerleft}
	\savedanchor{\lowerleft}{%
		#1
		\pgfpoint{\x{Tinnerleft}}{\y{Tinnerbottom}}
	}
	\anchor{lower center}{\lowercenter}%
	\savedanchor{\lowercenter}{%
		#1
		\pgfpoint{0}{\y{Tinnerbottom}}
	}
	\anchor{lower right}{\lowerright}%
	\savedanchor{\lowerright}{%
		#1
		\pgfpoint{\x{Tinnerright}}{\y{Tinnerbottom}}
	}
	\anchor{top left}{\topleft}%
	\savedanchor{\topleft}{%
		#1
		\pgfpoint{\x{Tinnerleft}}{-\y{Tbottom}}
	}
	\anchor{top center}{\topcenter}%
	\savedanchor{\topcenter}{%
		#1
		\pgfpoint{0}{-\y{Tbottom}}
	}
	\anchor{top right}{\topright}%
	\savedanchor{\topright}{%
		#1
		\pgfpoint{\x{Tinnerright}}{-\y{Tbottom}}
	}
	\anchor{upper left}{\upperleft}%
	\savedanchor{\upperleft}{%
		#1
		\pgfpoint{\x{Tinnerleft}}{-\y{Tinnerbottom}}
	}
	\anchor{upper center}{\uppercenter}%
	\savedanchor{\uppercenter}{%
		#1
		\pgfpoint{0}{-\y{Tinnerbottom}}
	}
	\anchor{upper right}{\upperright}%
	\savedanchor{\upperright}{%
		#1
		\pgfpoint{\x{Tinnerright}}{-\y{Tinnerbottom}}
	}
	\anchor{west}{\west}%
	\savedanchor{\west}{%
		#1
    \pgfpoint{\x{outerleft}}{\y{center}}
	}
	\anchor{east}{\east}%
	\savedanchor{\east}{%
		#1
    \pgfpoint{\x{outerright}}{\y{center}}
	}
	\anchor{north}{\north}%
	\savedanchor{\north}{%
		#1
    \pgfpoint{\x{center}}{\y{outertop}}
	}
	\anchor{north west}{\northwest}%
	\savedanchor{\northwest}{%
		#1
    \pgfpoint{\x{outerleft}}{\y{outertop}}
	}
	\anchor{north east}{\northeast}%
	\savedanchor{\northeast}{%
		#1
    \pgfpoint{\x{outerright}}{\y{outertop}}
	}
	\anchor{south}{\south}%
	\savedanchor{\south}{%
		#1
    \pgfpoint{\x{center}}{\y{outerbottom}}
	}
	\anchor{south west}{\southwest}%
	\savedanchor{\southwest}{%
		#1
    \pgfpoint{\x{outerleft}}{\y{outerbottom}}
	}
	\anchor{south east}{\southeast}%
	\savedanchor{\southeast}{%
		#1
    \pgfpoint{\x{outerright}}{\y{outerbottom}}
	}
	\anchor{1+}{\NodeA}
	\savedanchor{\NodeA}{
		#1
    \pgfpoint{\x{outerleft}}{\y{innertop}}
	}
	\anchor{1-}{\NodeB}
	\savedanchor{\NodeB}{
		#1
    \pgfpoint{\x{outerleft}}{\y{innerbottom}}
	}
	\anchor{inner 1+}{\NodeAi}
	\savedanchor{\NodeAi}{
		#1
    \pgfpoint{\x{innerleft}}{\y{innertop}}
	}
	\anchor{inner 1-}{\NodeBi}
	\savedanchor{\NodeBi}{
		#1
    \pgfpoint{\x{innerleft}}{\y{innerbottom}}
	}
}



\pgfdeclareshape{Quad shape}{
%
  \ctikzext@@QuadBaseAnchors{\ctikzext@@QuadPoints}
%
	\anchor{2+}{\NodeC}
	\savedanchor{\NodeC}{
		\ctikzext@@QuadPoints
    \pgfpoint{\x{outerright}}{\y{innertop}}
	}
	\anchor{2-}{\NodeD}
	\savedanchor{\NodeD}{
		\ctikzext@@QuadPoints
    \pgfpoint{\x{outerright}}{\y{innerbottom}}
	}
	\anchor{inner 2+}{\NodeCi}
	\savedanchor{\NodeCi}{
		\ctikzext@@QuadPoints
    \pgfpoint{\x{innerright}}{\y{innertop}}
	}
	\anchor{inner 2-}{\NodeDi}
	\savedanchor{\NodeDi}{
		\ctikzext@@QuadPoints
    \pgfpoint{\x{innerright}}{\y{innerbottom}}
	}
%  
	\behindbackgroundpath{%  this is new
		\ctikzext@@QuadPoints
		\pgfpathmoveto{\pgfpoint{\x{left}}{\y{bottom}}} 
		\pgfpathlineto{\pgfpoint{\x{left}}{\y{top}}}
		\pgfpathlineto{\pgfpoint{\x{right}}{\y{top}}}
		\pgfpathlineto{\pgfpoint{\x{right}}{\y{bottom}}}
		\pgfpathlineto{\pgfpoint{\x{left}}{\y{bottom}}}
		\pgfpathmoveto{\pgfpoint{\x{outerleft}}{\y{innerbottom}}}
		\pgfpathlineto{\pgfpoint{\x{innerleft}}{\y{innerbottom}}}
		\pgfpathmoveto{\pgfpoint{-\x{outerleft}}{\y{innerbottom}}}
		\pgfpathlineto{\pgfpoint{-\x{innerleft}}{\y{innerbottom}}}
		\pgfpathmoveto{\pgfpoint{\x{outerleft}}{\y{innertop}}}
		\pgfpathlineto{\pgfpoint{\x{innerleft}}{\y{innertop}}} 
		\pgfpathmoveto{\pgfpoint{-\x{outerleft}}{\y{innertop}}}
		\pgfpathlineto{\pgfpoint{-\x{innerleft}}{\y{innertop}}}
    \ctikzext@@plussignat[\ctikzext@@ValueofQuadKey{plussign len}/2]{\x{outerleft}+\ctikzext@@ValueofQuadKey{outer ext}/2}{\y{innertop}-\ctikzext@@ValueofQuadKey{outer ext}/2}
    \ctikzext@@minussignat[\ctikzext@@ValueofQuadKey{minussign len}/2]{\x{outerleft}+\ctikzext@@ValueofQuadKey{outer ext}/2}{\y{innerbottom}+\ctikzext@@ValueofQuadKey{outer ext}/2}
    \ctikzext@@plussignat[\ctikzext@@ValueofQuadKey{plussign len}/2]{-\x{outerleft}-\ctikzext@@ValueofQuadKey{outer ext}/2}{\y{innertop}-\ctikzext@@ValueofQuadKey{outer ext}/2}
    \ctikzext@@minussignat[\ctikzext@@ValueofQuadKey{minussign len}/2]{-\x{outerleft}-\ctikzext@@ValueofQuadKey{outer ext}/2}{\y{innerbottom}+\ctikzext@@ValueofQuadKey{outer ext}/2}
    \pgfusepath{draw}
    \ctikzext@@arrowtipat{0}{\x{outerleft}+\ctikzext@@ValueofQuadKey{outer ext}/2}{\y{innertop}}
    \ctikzext@@arrowtipat{180}{-\x{outerleft}-\ctikzext@@ValueofQuadKey{outer ext}/2}{\y{innertop}}
    \pgfusepath{draw,fill}
    %
    \iftoggle{ctikzext@@toggle@innerocirc}{
    {
      \pgftransformshift{\pgfpoint{-\x{innerleft}}{\y{innertop}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 2+}{}
    }
    {
      \pgftransformshift{\pgfpoint{\x{innerleft}}{\y{innertop}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 1+}{}
    }
    {
      \pgftransformshift{\pgfpoint{\x{innerleft}}{\y{innerbottom}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 1-}{}
    }
    {
      \pgftransformshift{\pgfpoint{-\x{innerleft}}{\y{innerbottom}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 2-}{}
    }
    }{}  
    % 
    \iftoggle{ctikzext@@toggle@outerocirc}{
    {
      \pgftransformshift{\pgfpoint{-\x{outerleft}}{\y{innertop}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 2+}{}
    }
    {
      \pgftransformshift{\pgfpoint{\x{outerleft}}{\y{innertop}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 1+}{}
    }
    {
      \pgftransformshift{\pgfpoint{\x{outerleft}}{\y{innerbottom}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 1-}{}
    }
    {
      \pgftransformshift{\pgfpoint{-\x{outerleft}}{\y{innerbottom}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 2-}{}
    }
    }{}  
    % 
    {
    		\pgfsetdash{{0.8pt}{1pt}{0.2pt}{1pt}}{0pt}
        \pgfsetlinewidth{0.5\pgflinewidth}
    		\pgfpathmoveto{\pgfpoint{-\x{refA}}{\y{innerbottom}}}
    		\pgfpathlineto{\pgfpoint{\x{refA}}{\y{innerbottom}}}
    \pgfusepath{draw}
    }
		\iftoggle{ctikzext@@toggle@inverted}{
			\pgftransformresetnontranslations
			\pgftext[bottom,right,at={\pgfpoint{\x{left}-0.4ex}{\y{innertop}+0.8ex}}]{\ctikzext@@ValueofQuadKey{I2}}
			\pgftext[bottom,left,at={\pgfpoint{\x{right}+0.4ex}{\y{innertop}+0.8ex}}]{\ctikzext@@ValueofQuadKey{I1}}
			\pgftext[left,x=\x{right}+0.4ex]{\ctikzext@@ValueofQuadKey{V1}}
			\pgftext[right,x=\x{left}-0.4ex]{\ctikzext@@ValueofQuadKey{V2}}
		}{
			%\pgftransformresetnontranslations   %might be added, changes nothing if nothing scaled/rotated.
			\pgftext[bottom,left,at={\pgfpoint{\x{right}+0.4ex}{\y{innertop}+0.8ex}}]{\ctikzext@@ValueofQuadKey{I2}}
			\pgftext[bottom,right,at={\pgfpoint{\x{left}-0.4ex}{\y{innertop}+0.8ex}}]{\ctikzext@@ValueofQuadKey{I1}}
			\pgftext[right,x=\x{left}-0.4ex]{\ctikzext@@ValueofQuadKey{V1}}
			\pgftext[left,x=\x{right}+0.4ex]{\ctikzext@@ValueofQuadKey{V2}}
		}
	}
	\backgroundpath{	\pgftransformresetnontranslations}
}


\newcommand{\ctikzext@@plussignat}[3][\ctikzext@@ValueofQuadKey{plussign len}]{%
  {
			\pgftransformshift{\pgfpoint{#2}{#3}}
      \pgftransformscale{#1}
			\pgfpathmoveto{\pgfpoint{-1}{0}}
			\pgfpathlineto{\pgfpoint{1}{0}}
			\pgfpathmoveto{\pgfpoint{0}{-1}}
			\pgfpathlineto{\pgfpoint{0}{1}}    
  }
}

\newcommand{\ctikzext@@minussignat}[3][\ctikzext@@ValueofQuadKey{minussign len}]{%
  {
			\pgftransformshift{\pgfpoint{#2}{#3}}
      \pgftransformscale{#1}
			\pgfpathmoveto{\pgfpoint{-1}{0}}
			\pgfpathlineto{\pgfpoint{1}{0}}
  }
}

%%%%%%%%%%%
%%%%%%%%%%%
%%%%% QuadZ
%%%%%%%%%%%
%%%%%%%%%%%
\pgfdeclareshape{Quad Z shape}{
	\inheritsavedanchors[from=Quad shape]
	\foreach \anchor in {north,center,west,east,south,north west,north east,south west, south east,
	text,bottom left,bottom right,bottom center, lower left, lower right, lower center,
	top left,top right,top center, upper left, upper right, upper center,
	1+,2+,1-,2-, inner 1+, inner 2+, inner 1-, inner 2-}{%
		\inheritanchor[from=Quad shape]{\anchor}}
	\inheritbehindbackgroundpath[from=Quad shape]
	\backgroundpath{
		\ctikzext@@QuadPoints
		\ctikzext@@Zside{Z11}{Z12}{I2}{}
		\ctikzext@@Zside{Z22}{Z21}{I1}{-}
		\pgftransformresetnontranslations
	}
}



%%%%%%%%%%%
%%%%%%%%%%%
%%%%% QuadY
%%%%%%%%%%%
%%%%%%%%%%%
\pgfdeclareshape{Quad Y shape}{
	\inheritsavedanchors[from=Quad shape]
	\foreach \anchor in {north,center,west,east,south,north west,north east,south west, south east,
	text,bottom left,bottom right,bottom center, lower left, lower right, lower center,
	top left,top right,top center, upper left, upper right, upper center,
	1+,2+,1-,2-, inner 1+, inner 2+, inner 1-, inner 2-}{%
		\inheritanchor[from=Quad shape]{\anchor}}
	\inheritbehindbackgroundpath[from=Quad shape]
	\backgroundpath{
		\ctikzext@@QuadPoints
		\ctikzext@@Yside{Y11}{Y12}{V2}{}
		\ctikzext@@Yside{Y22}{Y21}{V1}{-}
		\pgftransformresetnontranslations
	}
}


%%%%%%%%%%%
%%%%%%%%%%%
%%%%% QuadH
%%%%%%%%%%%
%%%%%%%%%%%
\pgfdeclareshape{Quad H shape}{
	\inheritsavedanchors[from=Quad shape]
	\foreach \anchor in {north,center,west,east,south,north west,north east,south west, south east,
	text,bottom left,bottom right,bottom center, lower left, lower right, lower center,
	top left,top right,top center, upper left, upper right, upper center,
	1+,2+,1-,2-, inner 1+, inner 2+, inner 1-, inner 2-}{%
		\inheritanchor[from=Quad shape]{\anchor}}
	\inheritbehindbackgroundpath[from=Quad shape]
	\backgroundpath{
		\ctikzext@@QuadPoints
		\ctikzext@@Zside{H11}{H12}{V2}{}
		\ctikzext@@Yside{H22}{H21}{I1}{-}
		\pgftransformresetnontranslations
	}
}

%%%%%%%%%%%
%%%%%%%%%%%
%%%%% QuadG
%%%%%%%%%%%
%%%%%%%%%%%
\pgfdeclareshape{Quad G shape}{
	\inheritsavedanchors[from=Quad shape]
	\foreach \anchor in {north,center,west,east,south,north west,north east,south west, south east,
	text,bottom left,bottom right,bottom center, lower left, lower right, lower center,
	top left,top right,top center, upper left, upper right, upper center,
	1+,2+,1-,2-, inner 1+, inner 2+, inner 1-, inner 2-}{%
		\inheritanchor[from=Quad shape]{\anchor}}
	\inheritbehindbackgroundpath[from=Quad shape]
	\backgroundpath{
		\ctikzext@@QuadPoints
		\ctikzext@@Yside{G11}{G12}{I2}{}
		\ctikzext@@Zside{G22}{G21}{V1}{-}
		\pgftransformresetnontranslations
	}
}



%%%%%%%%%%%
%%%%%%%%%%%
%%%%% Just a 'handy' macro for a parallel connection (needs a recent kernel, thought)
%%%%%%%%%%%
%%%%%%%%%%%
\NewDocumentCommand{\QuadParConnect}{smmm}{
	\ifstrequal{#4}{1}{\def\ctikzext@@Qsig{-}}{\def\ctikzext@@Qsig{}}
  \IfBooleanTF{#1}{
    \draw
			(#3.#4+) -- ++(\ctikzext@@Qsig\ctikzext@@ValueofQuadKey{outer ext}/2,0) |- (#2.#4+)
      (#3.#4-) to[out=90,in=90] ++(\ctikzext@@Qsig\ctikzext@@ValueofQuadKey{outer ext},0) -- ++(\ctikzext@@Qsig\ctikzext@@ValueofQuadKey{outer ext}/2,0)  |- (#2.#4-)
      ;
	}{
		\draw 
			(#3.#4-) -- ++(\ctikzext@@Qsig\ctikzext@@ValueofQuadKey{outer ext}/2,0) |- (#2.#4-)
      (#2.#4+) to[out=90,in=90] ++(\ctikzext@@Qsig\ctikzext@@ValueofQuadKey{outer ext},0) -- ++(\ctikzext@@Qsig\ctikzext@@ValueofQuadKey{outer ext}/2,0)  |- (#3.#4+)
    ;
	}
}




%%%%%%%%%%%
%%%%%%%%%%%
%%%%% Black Box
%%%%%%%%%%%
%%%%%%%%%%%
\pgfdeclareshape{BB shape}{
  \ctikzext@@QuadBaseAnchors{\ctikzext@@BBPoints}
	\behindbackgroundpath{
		\ctikzext@@BBPoints
		\pgfpathmoveto{\pgfpoint{\x{left}}{\y{bottom}}}
		\pgfpathlineto{\pgfpoint{\x{left}}{\y{top}}}
		\pgfpathlineto{\pgfpoint{\x{right}}{\y{top}}}
		\pgfpathlineto{\pgfpoint{\x{right}}{\y{bottom}}}
		\pgfpathlineto{\pgfpoint{\x{left}}{\y{bottom}}}
		\pgfpathmoveto{\pgfpoint{\x{outerleft}}{\y{innerbottom}}}
		\pgfpathlineto{\pgfpoint{\x{innerleft}}{\y{innerbottom}}}
		\pgfpathmoveto{\pgfpoint{\x{outerleft}}{\y{innertop}}}
		\pgfpathlineto{\pgfpoint{\x{innerleft}}{\y{innertop}}}
    \ctikzext@@plussignat[\ctikzext@@ValueofQuadKey{plussign len}/2]{\x{outerleft}+\ctikzext@@ValueofQuadKey{outer ext}/2}{\y{innertop}-\ctikzext@@ValueofQuadKey{outer ext}/2}
    \ctikzext@@minussignat[\ctikzext@@ValueofQuadKey{minussign len}/2]{\x{outerleft}+\ctikzext@@ValueofQuadKey{outer ext}/2}{\y{innerbottom}+\ctikzext@@ValueofQuadKey{outer ext}/2}
		\pgfusepath{draw}
    \ctikzext@@arrowtipat{180}{\x{outerleft}+\ctikzext@@ValueofQuadKey{outer ext}/2}{\y{innertop}}
		\pgfusepath{draw,fill}
    %
    \iftoggle{ctikzext@@toggle@innerocirc}{
    {
      \pgftransformshift{\pgfpoint{\x{innerleft}}{\y{innertop}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 1+}{}
    }
    {
      \pgftransformshift{\pgfpoint{\x{innerleft}}{\y{innerbottom}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 1-}{}
    }
    }{}   
    %
    \iftoggle{ctikzext@@toggle@outerocirc}{
    {
      \pgftransformshift{\pgfpoint{\x{outerleft}}{\y{innertop}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 1+}{}
    }
    {
      \pgftransformshift{\pgfpoint{\x{outerleft}}{\y{innerbottom}}}
      \pgfnode{ocirc}{center}{}{\tikz@fig@name-oc 1-}{}
    }
    }{}   
    %
		\iftoggle{ctikzext@@toggle@inverted}{
			\pgftransformresetnontranslations
			\pgftext[bottom,left,at={\pgfpoint{\x{right}+0.4ex}{\y{innertop}+0.8ex}}]{\ctikzext@@ValueofQuadKey{I1}}
			\pgftext[left,x=\x{right}+0.4ex]{\ctikzext@@ValueofQuadKey{V1}}
		}{
			\pgftext[bottom,right,at={\pgfpoint{\x{left}-0.4ex}{\y{innertop}+0.8ex}}]{\ctikzext@@ValueofQuadKey{I1}}
			\pgftext[right,x=\x{left}-0.4ex]{\ctikzext@@ValueofQuadKey{V1}}
		}
		\pgfusepath{draw}
	}
	\backgroundpath{}
}


%%%%%%%%%%%
%%%%%%%%%%%
%%%%% Thevenin
%%%%%%%%%%%
%%%%%%%%%%%
\pgfdeclareshape{TheveninBB shape}{
	\inheritsavedanchors[from=BB shape]
	\foreach \anchor in {north,center,west,east,south,north west,north east,south west, south east,
	text,bottom left,bottom right,bottom center, lower left, lower right, lower center,
	top left,top right,top center, upper left, upper right, upper center,
	1+,1-, inner 1+, inner 1-}{%
		\inheritanchor[from=BB shape]{\anchor}}
	\inheritbehindbackgroundpath[from=BB shape]
	\backgroundpath{
		\ctikzext@@BBPoints
		\ctikzext@@Zside{Zth}{Vth}{none}{}
		\pgftransformresetnontranslations
	}
}


%%%%%%%%%%%
%%%%%%%%%%%
%%%%% Norton
%%%%%%%%%%%
%%%%%%%%%%%
\pgfdeclareshape{NortonBB shape}{
	\inheritsavedanchors[from=BB shape]
	\foreach \anchor in {north,center,west,east,south,north west,north east,south west, south east,
	text,bottom left,bottom right,bottom center, lower left, lower right, lower center,
	top left,top right,top center, upper left, upper right, upper center,
	1+,1-, inner 1+, inner 1-}{%
		\inheritanchor[from=BB shape]{\anchor}}
	\inheritbehindbackgroundpath[from=BB shape]
	\backgroundpath{
		\ctikzext@@BBPoints
    \ctikzext@@Yside[IsourceUP shape]{Yn}{In}{none}{}
		\pgftransformresetnontranslations
	}
}


